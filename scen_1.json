{
  "name": "GrandTent Auto-Quotation",
  "nodes": [
    {
      "parameters": {
        "event": "ON_CRM_DEAL_ADD",
        "additionalFields": {
          "fields": ["ID","TITLE","UF_CRM_PRODUCT_TYPE","UF_CRM_SIZE","UF_CRM_MATERIAL"]
        },
        "credentials": {
          "authType":"webhook",
          "webhookPath":"https://your_domain/make/bitrix-webhook"
        }
      },
      "name":"Bitrix24 Trigger",
      "type":"bitrix24-trigger",
      "typeVersion":1
    },
    {
      "parameters": {
        "condition":"{{$json.UF_CRM_PRODUCT_TYPE && $json.UF_CRM_SIZE && $json.UF_CRM_MATERIAL}}"
      },
      "name":"Filter Required Fields",
      "type":"n8n-nodes-base.if",
      "typeVersion":1
    },
    {
      "parameters": {
        "jsCode":"const deal = $json; return [{ json: { messages: [ { role:'system', content:'–¢—ã –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç GrandTent. –°–≥–µ–Ω–µ—Ä–∏—Ä—É–π –∫–æ–º–º–µ—Ä—á–µ—Å–∫–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –≤ —Ñ–æ—Ä–º–∞—Ç–µ HTML –±–µ–∑ CSS. –°—Ç—Ä—É–∫—Ç—É—Ä–∞:\\n‚Ä¢ –®–∞–ø–∫–∞ (–ª–æ–≥–æ—Ç–∏–ø + –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏)\\n‚Ä¢ –ü–∞—Ä–∞–º–µ—Ç—Ä—ã (—Ç–∞–±–ª–∏—Ü–∞)\\n‚Ä¢ –†–∞—Å—á–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏\\n‚Ä¢ –°—Ä–æ–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞\\n‚Ä¢ –ö–æ–Ω—Ç–∞–∫—Ç—ã\\n–î–∞–Ω–Ω—ã–µ –ø—Ä–æ–¥–∞–∂–∏:' }, { role:'user', content:`–¢–∏–ø: ${deal.UF_CRM_PRODUCT_TYPE}\\n–†–∞–∑–º–µ—Ä: ${deal.UF_CRM_SIZE}\\n–ú–∞—Ç–µ—Ä–∏–∞–ª: ${deal.UF_CRM_MATERIAL}\\n–ö–ª–∏–µ–Ω—Ç: ${deal.TITLE}\\nID —Å–¥–µ–ª–∫–∏: ${deal.ID}` } ], model:'gpt‚Äë4‚Äëturbo' } }];"
      },
      "name":"Build GPT Prompt",
      "type":"n8n-nodes-base.function",
      "typeVersion":1
    },
    {
      "parameters": {
        "model":"={{$json.model}}",
        "messages":"={{$json.messages}}",
        "options":{}
      },
      "name":"Generate Proposal",
      "type":"n8n-nodes-base.openAi",
      "typeVersion":1,
      "credentials":{"apiKey":"{{YOUR_OPENAI_KEY}}"}
    },
    {
      "parameters":{
        "continueOnFail":true
      },
      "name":"Catch GPT Errors",
      "type":"n8n-nodes-base.errorTrigger",
      "typeVersion":1
    },
    {
      "parameters":{
        "operation":"sendMessage",
        "chatId":"{{MANAGER_CHAT_ID}}",
        "text":"‚ùóÔ∏è–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –öp –¥–ª—è —Å–¥–µ–ª–∫–∏ #{{$node[\"Bitrix24 Trigger\"].json.ID}}. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–ª–∏ API."
      },
      "name":"Notify on GPT error",
      "type":"n8n-nodes-base.telegram",
      "typeVersion":1,
      "credentials":{"accessToken":"{{YOUR_TELEGRAM_TOKEN}}"}
    },
    {
      "parameters": {
        "html":"={{$json.choices[0].message.content}}",
        "options":{"format":"A4","margin":"20mm"}
      },
      "name":"Convert to PDF",
      "type":"n8n-nodes-base.htmlToPdf",
      "typeVersion":1
    },
    {
      "parameters":{
        "operation":"sendDocument",
        "file":"={{$json.pdf}}",
        "chatId":"{{MANAGER_CHAT_ID}}",
        "caption":"üìÑ –ö–ü –¥–ª—è —Å–¥–µ–ª–∫–∏ #{{$node[\"Bitrix24 Trigger\"].json.ID}}",
        "credentials":{"accessToken":"{{YOUR_TELEGRAM_TOKEN}}"}
      },
      "name":"Send to Telegram",
      "type":"n8n-nodes-base.telegram",
      "typeVersion":1
    },
    {
      "parameters":{
        "operation":"upload",
        "file":"={{$node[\"Convert to PDF\"].binary.pdf.data}}",
        "fields":{"element_id":"{{$node[\"Bitrix24 Trigger\"].json.ID}}"}
      },
      "name":"Upload PDF to Bitrix24 Files",
      "type":"n8n-nodes-base.bitrix24",
      "typeVersion":1,
      "credentials":{"oauth2":"YOUR_BITRIX_CRED"}
    }
  ],
  "connections":{
    "Bitrix24 Trigger":{"main":[[{"node":"Filter Required Fields"}]]},
    "Filter Required Fields":{"main":[[{"node":"Build GPT Prompt"}]],"else":[[{"node":"Notify on GPT error"}]]},
    "Build GPT Prompt":{"main":[[{"node":"Generate Proposal"}]]},
    "Generate Proposal":{"main":[[{"node":"Convert to PDF"}]],"error":[[{"node":"Catch GPT Errors"}]]},
    "Catch GPT Errors":{"main":[[{"node":"Notify on GPT error"}]]},
    "Convert to PDF":{"main":[[{"node":"Send to Telegram"},{"node":"Upload PDF to Bitrix24 Files"}]]}
  },
  "active":true,
  "settings":{"executionOrder":"v1"},
  "id":"grandtent-auto-quote",
  "version":2
}

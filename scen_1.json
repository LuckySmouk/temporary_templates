{
  "nodes": [
    {
      "name": "Bitrix24 Trigger",
      "type": "bitrix24-trigger",
      "parameters": {
        "event": "ON_CRM_DEAL_ADD",
        "credentials": "{{BITRIX24_CRED}}"
      }
    },
    {
      "name": "Build GPT Prompt",
      "type": "function",
      "parameters": {
        "functionCode": "const deal = items[0].json; return { model: 'gpt-4-turbo', messages: [ { role: 'system', content: 'Ты ассистент GrandTent. Сгенерируй текст КП в формате HTML с таблицами. Структура: заголовок, параметры, стоимость, сроки. Данные:' }, { role: 'user', content: JSON.stringify({ client: deal.TITLE || 'Не указан', type: deal.UF_CRM_TYPE || 'Не указан', size: deal.UF_CRM_SIZE || 'Не указан', material: deal.UF_CRM_MATERIAL || 'Не указан' }) } ] };"
      }
    },
    {
      "name": "Call OpenAI",
      "type": "openai",
      "parameters": {
        "resource": "chat",
        "operation": "create",
        "model": "={{ $json.model }}",
        "messages": "={{ $json.messages }}",
        "credentials": "{{OPENAI_API_KEY}}"
      }
    },
    {
      "name": "Convert to PDF",
      "type": "htmlToPdf",
      "parameters": {
        "html": "={{ $node['Call OpenAI'].json.choices[0].message.content }}",
        "options": {
          "format": "A4",
          "margin": "20mm"
        }
      }
    },
    {
      "name": "Send to Telegram",
      "type": "telegram",
      "parameters": {
        "operation": "sendDocument",
        "file": "={{ $node['Convert to PDF'].json.pdf }}",
        "chatId": "{{MANAGER_CHAT_ID}}",
        "caption": "КП для сделки №" + "{{ $node['Bitrix24 Trigger'].json.ID }}"
      }
    }
  ]
}
